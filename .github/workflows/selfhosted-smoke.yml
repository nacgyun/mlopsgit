name: SelfHosted Smoke
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  hello:
    runs-on: [self-hosted, linux, x64, mlops, k8s]
    steps:
      - uses: actions/checkout@v4

      - name: Configure in-cluster kubectl   # ← 여기 추가
        run: |
          set -euo pipefail
          SVC_HOST="${KUBERNETES_SERVICE_HOST:-kubernetes.default.svc}"
          SVC_PORT="${KUBERNETES_SERVICE_PORT:-443}"

          TOKEN_PATH="/var/run/secrets/kubernetes.io/serviceaccount/token"
          CA_PATH="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"

          kubectl config set-cluster in-cluster \
            --server="https://${SVC_HOST}:${SVC_PORT}" \
            --certificate-authority="${CA_PATH}"
          kubectl config set-credentials sa --token="$(cat ${TOKEN_PATH})"
          kubectl config set-context in-cluster --cluster=in-cluster --user=sa
          kubectl config use-context in-cluster

          kubectl version --short

      - name: Test kubectl
        run: |
          kubectl get pods -A

