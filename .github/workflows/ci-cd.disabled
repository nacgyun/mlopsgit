name: CI/CD

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    env:
      NAMESPACE: mlops
      # 서비스 IP(10.96.0.1) 대신 마스터 노드 API서버로 직접 연결
      APISERVER: https://10.100.0.104:6443
      SA_CA: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      SA_TOKEN_FILE: /var/run/secrets/kubernetes.io/serviceaccount/token
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Diagnostics (whoami/env/kubectl)
        run: |
          set -x
          whoami
          uname -a
          kubectl version --client
          echo "APISERVER=${APISERVER}"
          ls -l /var/run/secrets/kubernetes.io/serviceaccount || true

      - name: Configure kubeconfig (direct to master API)
        run: |
          set -euo pipefail
          SA_TOKEN="$(cat "$SA_TOKEN_FILE")"
          kubectl config set-cluster in-cluster \
            --server="${APISERVER}" \
            --certificate-authority="${SA_CA}" \
            --embed-certs=true
          kubectl config set-credentials sa --token="${SA_TOKEN}"
          kubectl config set-context in-cluster --cluster=in-cluster --user=sa --namespace="${NAMESPACE}"
          kubectl config use-context in-cluster
          # 빠른 접속 테스트
          kubectl version

      - name: Apply manifests
        run: |
          set -euo pipefail
          for d in k8s manifests kubernetes; do
            if [ -d "$d" ]; then MANIFEST_DIR="$d"; break; fi
          done
          if [ -z "${MANIFEST_DIR:-}" ]; then
            echo "::error::No manifest directory found (expected: k8s/ or manifests/ or kubernetes/)"
            exit 1
          fi
          echo "Applying from $MANIFEST_DIR"
          kubectl -n "$NAMESPACE" apply -R -f "$MANIFEST_DIR"
          kubectl -n "$NAMESPACE" get all -o wide
