apiVersion: batch/v1
kind: Job
metadata:
  name: __KANIKO_JOB_NAME__
  namespace: __NAMESPACE__
  labels:
    app: kaniko
    purpose: runtime-build
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: kaniko
        purpose: runtime-build
    spec:
      restartPolicy: Never

      # 클러스터가 프록시/DNS 느릴 때 완화 옵션(선택)
      dnsConfig:
        options:
          - { name: ndots, value: "1" }
          - { name: timeout, value: "2" }
          - { name: attempts, value: "2" }

      containers:
        - name: kaniko
          image: gcr.io/kaniko-project/executor:v1.23.0
          imagePullPolicy: IfNotPresent
          args:
            # Git 컨텍스트: 특정 커밋 고정
            - --context=git://github.com/__GITHUB_OWNER__/__GITHUB_REPO__.git#__GIT_SHA__
            - --dockerfile=Dockerfile.runtime

            # 빌드 산출물 푸시 (content-hash 태그 + latest runtime)
            - --destination=ghcr.io/__GITHUB_OWNER__/__GITHUB_REPO__:runtime-__BUILD_KEY__
            - --destination=ghcr.io/__GITHUB_OWNER__/__GITHUB_REPO__:runtime

            # 캐시 사용 (레포는 /cache 네임스페이스 하위)
            - --cache=true
            - --cache-repo=ghcr.io/__GITHUB_OWNER__/__GITHUB_REPO__/cache

            # 로그 상세
            - --verbosity=info
          env:
            - name: GODEBUG
              value: "ipv6=0"
            - name: DOCKER_CONFIG
              value: /kaniko/.docker
          volumeMounts:
            - name: docker-config
              mountPath: /kaniko/.docker

      volumes:
        - name: docker-config
          secret:
            secretName: docker-config        # /.docker/config.json 를 담은 시크릿
            items:
              - key: .dockerconfigjson
                path: config.json

