apiVersion: batch/v1
kind: Job
metadata:
  name: __KANIKO_JOB_NAME__
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kaniko-build
    allow-egress-internet: "true"
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 1800
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kaniko-build
        allow-egress-internet: "true"
    spec:
      restartPolicy: Never

      volumes:
        - name: workspace
          emptyDir: {}
        - name: docker-config
          secret:
            secretName: ghcr-creds        # GHCR dockerconfigjson (workflow에서 생성/갱신)
        - name: host-certs
          hostPath:
            path: /etc/ssl/certs
            type: Directory

      # 깃은 init에서 처리 → Kaniko는 디렉터리 컨텍스트만 사용
      initContainers:
        - name: fetch-source
          image: alpine/git:latest
          env:
            - name: GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: gh-pat            # workflow가 생성하는 Opaque 시크릿
                  key: PAT
            - name: GIT_BRANCH
              value: "master"             # 기본 브랜치(네 레포는 main 아님)
          command: ["/bin/sh","-lc"]
          args:
            - |
              set -euo pipefail
              REPO_OWNER="__GITHUB_OWNER__"
              REPO_NAME="__GITHUB_REPO__"
              REPO_URL="https://${GH_TOKEN}:x-oauth-basic@github.com/${REPO_OWNER}/${REPO_NAME}.git"
              BRANCH="${GIT_BRANCH}"
              echo "[clone] ${REPO_OWNER}/${REPO_NAME} (branch: ${BRANCH})"
              git clone --depth=1 --branch "${BRANCH}" "${REPO_URL}" /workspace/repo
          volumeMounts:
            - name: workspace
              mountPath: /workspace

      containers:
        - name: kaniko
          image: gcr.io/kaniko-project/executor:latest
          args:
            - "--context=/workspace/repo"
            - "--dockerfile=ml/Dockerfile"
            - "--destination=ghcr.io/__GITHUB_OWNER__/__IMAGE_REPO__:runtime-__BUILD_KEY__"
            - "--cache=true"
          env:
            - name: DOCKER_CONFIG
              value: /kaniko/.docker/
          volumeMounts:
            - name: workspace
              mountPath: /workspace
            - name: docker-config
              mountPath: /kaniko/.docker/
            - name: host-certs
              mountPath: /etc/ssl/certs
              readOnly: true

      imagePullSecrets:
        - name: ghcr-creds

