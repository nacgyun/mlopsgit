apiVersion: batch/v1
kind: Job
metadata:
  name: __JOB_NAME__          # e.g. train-job-<run_id>
  namespace: __NAMESPACE__
  labels:
    app: train
    run-id: "__RUN_ID__"      # ${{ github.run_id }}
    sha: "__GIT_SHA__"        # ${{ github.sha }}
    build-id: "__BUILD_ID__"  # ${{ github.run_number }}-${{ github.run_attempt }}
spec:
  backoffLimit: 0
  # (선택) 전체 타임아웃: 필요 시 조정 (초 단위, 예: 2시간)
  activeDeadlineSeconds: 7200
  template:
    metadata:
      labels:
        app: train
        run-id: "__RUN_ID__"
        sha: "__GIT_SHA__"
        build-id: "__BUILD_ID__"
    spec:
      restartPolicy: Never

      dnsConfig:
        options:
          - name: ndots
            value: "1"
          - name: timeout
            value: "2"
          - name: attempts
            value: "2"

      # GHCR private pull (리소스에 맞는 secret 이름 사용)
      imagePullSecrets:
        - name: ghcr-pull

      initContainers:
        - name: fetch-src
          image: alpine/git:2.45.2
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh","-lc"]
          args:
            - |
              set -euo pipefail
              echo "[fetch-src] start"
              GIT_URL="${GITHUB_TOKEN:+https://oauth2:${GITHUB_TOKEN}@github.com/__GITHUB_OWNER__/__GITHUB_REPO__.git}"
              GIT_URL="${GIT_URL:-https://github.com/__GITHUB_OWNER__/__GITHUB_REPO__.git}"
              SHA="__GIT_SHA__"

              git config --global http.lowSpeedLimit 1000
              git config --global http.lowSpeedTime 20
              git config --global core.longpaths true

              mkdir -p /workspace && cd /workspace
              git init
              git remote add origin "$GIT_URL"

              for i in 1 2 3; do
                git fetch --filter=blob:none --no-tags origin \
                  '+refs/heads/*:refs/remotes/origin/*' '+refs/tags/*:refs/tags/*' && break
                echo "[fetch-src] refs fetch retry $i"; sleep 3
              done

              for i in 1 2 3; do
                git fetch origin "$SHA" && break
                echo "[fetch-src] sha fetch retry $i"; sleep 3
              done

              git checkout --detach "$SHA"
              echo "[fetch-src] checked out $SHA"
              ls -al
          env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-token
                  key: token
          volumeMounts:
            - name: workspace
              mountPath: /workspace

      containers:
        - name: trainer
          image: __IMAGE__                 # ghcr.io/<owner>/<repo>:runtime-<key>
          imagePullPolicy: IfNotPresent
          workingDir: /opt/app
          resources:                       # (2) 리소스 지정: Burstable로
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2"
              memory: "3Gi"
          env:
            - name: PYTHONUNBUFFERED       # 실시간 로깅
              value: "1"
            - name: RUN_ID
              value: "__RUN_ID__"
            - name: BUILD_ID
              value: "__BUILD_ID__"
            - name: GIT_SHA
              value: "__GIT_SHA__"
            # ===== MLflow =====
            - name: MLFLOW_TRACKING_URI
              value: "http://mlflow.mlops.svc.cluster.local:5000"
            - name: MLFLOW_EXPERIMENT_NAME
              value: "iris-rf"
            # ===== MinIO/S3 (표준 키; 코드에서 그대로 사용) =====
            - name: S3_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: train-config        # (4) ConfigMap에 넣어둔 값
                  key: S3_ENDPOINT
            - name: S3_REGION
              valueFrom:
                configMapKeyRef:
                  name: train-config
                  key: S3_REGION
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-cred          # (4) Secret에 자격증명
                  key: S3_ACCESS_KEY
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-cred
                  key: S3_SECRET_KEY
            # ===== 데이터 경로 및 스키마 =====
            - name: DATA_S3_URI            # 예: s3://data/telco/  또는 단일 파일
              valueFrom:
                configMapKeyRef:
                  name: train-config
                  key: DATA_S3_URI
            - name: DATA_FORMAT            # auto|csv|parquet
              valueFrom:
                configMapKeyRef:
                  name: train-config
                  key: DATA_FORMAT
            - name: LABEL_COL              # 예: Churn
              valueFrom:
                configMapKeyRef:
                  name: train-config
                  key: LABEL_COL
            - name: DROP_COLS              # 예: customerID
              valueFrom:
                configMapKeyRef:
                  name: train-config
                  key: DROP_COLS
            # ===== AWS SDK 동작 관련(필수 아님, MinIO 권장 세팅) =====
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
            - name: AWS_EC2_METADATA_DISABLED
              value: "true"
            - name: AWS_S3_FORCE_PATH_STYLE
              value: "true"

            # ===== GHCR 정보(로그/디버그용) =====
            - name: GHCR_IMAGE
              value: "__GHCR_IMAGE__"          # ghcr.io/<owner>/<repo>
            - name: GHCR_TAG
              value: "__GHCR_TAG__"            # runtime-<BUILD_KEY or SHA>
            - name: GHCR_DIGEST
              value: "__GHCR_DIGEST__"         # sha256:....
            - name: GHCR_IMAGE_REF
              value: "__GHCR_IMAGE_REF__"      # ghcr.io/<owner>/<repo>@sha256:....

          # (4) 민감정보/일반설정 분리 주입
          envFrom:
            - secretRef:
                name: s3-mlflow-creds        # 기존 유지(있다면)
            - secretRef:
                name: minio-cred             # S3_ACCESS_KEY / S3_SECRET_KEY
            - configMapRef:
                name: train-config           # S3_ENDPOINT/REGION, DATA_*, LABEL/DROP_COLS

          command: ["/bin/sh","-lc"]
          args:
            - |
              set -eux
              echo "[trainer] using image: __IMAGE__"
              echo "[trainer] code SHA: ${GIT_SHA}"
              python -u ml/train.py          # 내부에서 S3 → pandas 로딩
          volumeMounts:
            - name: workspace
              mountPath: /opt/app

      volumes:
        - name: workspace
          emptyDir: {}

